<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=800, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sabotage ê²Œì„</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; background-color: #f4f6f9; }
    .container {  margin: 0 auto; }
    .card { 
      background: white;
      border-radius: 10px; 
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      padding: 15px;
      margin-bottom: 15px;
    }
    #log { 
      height: 300px; 
      border: 1px solid #ddd; 
      padding: 10px; 
      overflow-y: scroll; 
      background: #fff;
      border-radius: 5px;
      font-family: monospace;
    }
    .section { margin-bottom: 15px; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h2 {
      margin: 0;
      color: #3e62a8;
    }
    input, button { 
      margin-right: 5px; 
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    button {
      background: #3e62a8;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #2d4b82;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  

	<!-- <meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"> -->
	<!-- <link rel="shortcut icon" href="resources/images/favicon.ico" type="image/x-icon"> -->

	<!-- Bootstrap -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
	<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
	<!-- Bootstrap -->

	<!-- <link rel="stylesheet" href="style.css" type="text/css" media="screen"> -->
	<!-- <script src="openvidu-browser-2.31.0.js"></script> -->
	<script src="openvidu.js"></script>
	<script src="openvidu_app.js"></script>
</head>

</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <h2>Sabotage ê²Œì„</h2>
      <div>
        <span class="room-info" id="roomInfo"></span>
        <button class="secondary" id="btnBackToLobby">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
    
    <!-- ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ë‹¨ê³„ -->
    <div class="card" id="usernameSection">
      <h3>ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</h3>
      <div>
        <input type="text" id="userInput" placeholder="ì‚¬ìš©ì ì´ë¦„ ì…ë ¥" />
        <button id="btnSetUsername">í™•ì¸</button>
      </div>
      <div id="usernameError" style="color: red; margin-top: 5px;"></div>
    </div>
      <!-- ê²Œì„ ì¸í„°í˜ì´ìŠ¤ -->
    <div class="card" id="gameInterface" style="display: none;">
      <h3>í™˜ì˜í•©ë‹ˆë‹¤, <span id="welcomeUsername"></span>ë‹˜!</h3>
        <!-- ë°© ì„¤ì • ë° ê²Œì„ ì»¨íŠ¸ë¡¤ -->
      <div class="section">
        <label>ë°© ì´ë¦„: <input type="text" id="roomInput" disabled value="" /></label>
      </div>
      
      <!-- ì±„íŒ… -->
      <div class="section" hidden>
        <input type="text" id="chatMessage" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 70%;" />
        <button id="btnSendChat">ì±„íŒ… ë³´ë‚´ê¸°</button>
      </div>
    </div>    <!-- ë¡œê·¸ -->
    <div id="toast-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 9999;"></div>
    <div class="card" hidden>
      <h3 >ê²Œì„ ë¡œê·¸</h3>
      <div id="log"></div>
    </div>
    
    <!-- ê°œì¸ ë©”ì‹œì§€ ë·°ì–´ -->
    <div class="card">
      <h3>ê²Œì„ ì •ë³´</h3>
      <div id="privateGameViewer" style="border: 1px solid #ddd; padding: 10px; background: #f8f9fa; border-radius: 5px; white-space: pre;"></div>
    </div>
    <div class="card">
      <h3>ê°œì¸ë³„ ì •ë³´</h3>
      <div id="privateHandViewer" style="border: 1px solid #ddd; padding: 10px; background: #f8f9fa; border-radius: 5px; white-space: pre;"></div>
    </div>
        
    <div class="card">
      <h3>ë³´ë“œ</h3>
      <div id="privateMessageViewer" style="height: 800px; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; border-radius: 5px; white-space: pre;"></div>
    </div>
    <div class="card">
      <!-- ì—¬ê¸°ì— index.html ì‚½ì… -->
    
    
    
    
    <div id="main-container" class="container">
		<div id="join">
			<div id="join-dialog" class="jumbotron vertical-center hide">
				<h1>Join a video session</h1>
				<form class="form-group" onsubmit="joinSession(username,roomId); return false">
        
					<p>
						<label>Participant</label>
						<input class="form-control" type="text" id="userName" required>
					</p>
					<p>
						<label>Session</label>
						<input class="form-control" type="text" id="sessionId" required>
					</p>
					<p class="text-center">
						<input class="btn btn-lg btn-success" type="submit" name="commit" id="join-btn" value="Join!">
					</p>
				</form>
			</div>
		</div>

		<div id="session" style="display: none; height : 1px;">
			<div id="session-header">
				<h1 id="session-title" hidden></h1>
				<input class="btn btn-large btn-danger" hidden type="button" id="buttonLeaveSession" onmouseup="leaveSession()" value="Leave session">
			</div>
			<div id="main-video" class="col-md-6" style="height: 1px;"><p></p><video autoplay playsinline="true"></video></div>
			<div id="video-container" class="col-md-6"></div>
		</div>
	</div>
    
    
    
    
    
    </div>
  </div>
  <!-- socket.io-client CDN -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>  
  <script>
    let socket;
    let username = null;
    let isUsernameSet = false;
    let roomId = null;
    let boardViewState = {
          currentX: null,
          currentY: null,
          scale: 1
        };
    const logEl = document.getElementById('log');
    const userInput = document.getElementById('userInput');
    const btnSetUsername = document.getElementById('btnSetUsername');
    const usernameSection = document.getElementById('usernameSection');
    const gameInterface = document.getElementById('gameInterface');
    const welcomeUsername = document.getElementById('welcomeUsername');
    const usernameError = document.getElementById('usernameError');
    const roomInfo = document.getElementById('roomInfo');
    const btnBackToLobby = document.getElementById('btnBackToLobby');
    var GameBoardInfo = {}
    function log(msg) {
      const p = document.createElement('div');
      p.textContent = msg;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }    // URLì—ì„œ ë°© ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    function getRoomIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('room');    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const roomName = urlParams.get('room_name');
      const playerName = urlParams.get('player_name');
      
      
      if (roomName && playerName) {
        document.getElementById('sessionId').value = roomName;
        document.getElementById('userName').value = playerName;
        joinSession(); // ë‘˜ ë‹¤ ìˆìœ¼ë©´ ìë™ ì°¸ê°€
      }
      
      // ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ í™•ì¸
      const savedUsername = localStorage.getItem('username');
      console.log("localStorageì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì´ë¦„:", savedUsername);
      
      roomId = getRoomIdFromUrl();
      console.log("URLì—ì„œ ê°€ì ¸ì˜¨ ë°© ID:", roomId);
      
      // URLì— room íŒŒë¼ë¯¸í„°ê°€ ìˆê³  ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì ‘ì†
      if (roomId && savedUsername) {
        username = savedUsername;
        isUsernameSet = true;
        userInput.value = username;
        userInput.disabled = true;
        btnSetUsername.disabled = true;
        welcomeUsername.textContent = username;
        
        // ì‚¬ìš©ì ì´ë¦„ ì„¹ì…˜ ìˆ¨ê¸°ê³  ê²Œì„ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        usernameSection.style.display = 'none';
        gameInterface.style.display = 'block';
        
        // ë°© ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
        roomInfo.textContent = `ë°© ID: ${roomId}`;
        document.getElementById('roomInput').value = roomId;
        
        // ì„œë²„ ì—°ê²° ë° ê²Œì„ í™”ë©´ í‘œì‹œ
        connectToServer(savedUsername);
          
        // ìë™ìœ¼ë¡œ ë°©ì— ì°¸ê°€
        log(`ìë™ìœ¼ë¡œ ë°© ${roomId}ì— ì°¸ê°€ ì‹œë„ ì¤‘...`);
        setTimeout(() => {
          if (socket && socket.connected) {
            socket.emit('join_game', { room: roomId, player: username });
            joinSession(username, roomId);
            log(`ê²Œì„ ì°¸ê°€ ìš”ì²­: ë°©=${roomId}, ì‚¬ìš©ì=${username}`);
          }
        }, 1000); // ì„œë²„ ì—°ê²° í›„ 1ì´ˆ í›„ì— ë°© ì°¸ê°€ ìš”ì²­
      }      // URLì— room íŒŒë¼ë¯¸í„°ê°€ ìˆì§€ë§Œ ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ì´ ì—†ëŠ” ê²½ìš° - ìë™ ìƒì„±ëœ ì´ë¦„ ì‚¬ìš©
      else if (roomId && !savedUsername) {
        const autoUsername = 'ê²ŒìŠ¤íŠ¸_' + Math.floor(Math.random() * 10000);
        username = autoUsername;
        isUsernameSet = true;
        userInput.value = username;
        userInput.disabled = true;
        btnSetUsername.disabled = true;
        welcomeUsername.textContent = username;
        
        // ìë™ ìƒì„±ëœ ì´ë¦„ì„ localStorageì— ì €ì¥
        localStorage.setItem('username', username);
        console.log("ìë™ ìƒì„±ëœ ì‚¬ìš©ì ì´ë¦„ ì €ì¥:", username);
        
        // ì‚¬ìš©ì ì´ë¦„ ì„¹ì…˜ ìˆ¨ê¸°ê³  ê²Œì„ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        usernameSection.style.display = 'none';
        gameInterface.style.display = 'block';
        
        // ë°© ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
        roomInfo.textContent = `ë°© ID: ${roomId}`;
        document.getElementById('roomInput').value = roomId;
        
        // ì„œë²„ ì—°ê²° ë° ê²Œì„ í™”ë©´ í‘œì‹œ
        connectToServer(autoUsername);
        
        // ìë™ìœ¼ë¡œ ë°©ì— ì°¸ê°€
        log(`ìë™ìœ¼ë¡œ ë°© ${roomId}ì— ì°¸ê°€ ì‹œë„ ì¤‘...`);
        setTimeout(() => {
          if (socket && socket.connected) {
            socket.emit('join_game', { room: roomId, player: username });
            log(`ê²Œì„ ì°¸ê°€ ìš”ì²­: ë°©=${roomId}, ì‚¬ìš©ì=${username}`);
          } else {
            log(`ì„œë²„ ì—°ê²°ì´ ì•„ì§ ì•ˆëìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.`);
            // ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
            setTimeout(() => {
              if (socket && socket.connected) {
                socket.emit('join_game', { room: roomId, player: username });
                log(`ê²Œì„ ì°¸ê°€ ì¬ì‹œë„: ë°©=${roomId}, ì‚¬ìš©ì=${username}`);
              } else {
                log(`ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.`);
              }
            }, 2000);
          }
        }, 1000); // ì„œë²„ ì—°ê²° í›„ 1ì´ˆ í›„ì— ë°© ì°¸ê°€ ìš”ì²­
      }
      // URLì— room íŒŒë¼ë¯¸í„°ëŠ” ì—†ì§€ë§Œ ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ì´ ìˆëŠ” ê²½ìš°
      else if (savedUsername) {
        username = savedUsername;
        isUsernameSet = true;
        userInput.value = username;
        userInput.disabled = true;
        btnSetUsername.disabled = true;
        welcomeUsername.textContent = username;
        
        // ì‚¬ìš©ì ì´ë¦„ ì„¹ì…˜ ìˆ¨ê¸°ê³  ê²Œì„ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        usernameSection.style.display = 'none';
        gameInterface.style.display = 'block';
        
        // ì„œë²„ ì—°ê²° ë° ê²Œì„ í™”ë©´ í‘œì‹œ
        connectToServer(savedUsername);
        
        log(`ë¡œê·¸ì¸ ì™„ë£Œ: ${username}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`);
      }
      // ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
      btnBackToLobby.addEventListener('click', () => {
        // ë°©ì—ì„œ ë‚˜ê°€ê¸° ì´ë²¤íŠ¸ ë°œìƒ
        if (socket && socket.connected && roomId) {
          socket.emit('leave_room', { room: roomId, player: username });
          log(`[í‡´ì¥] ${roomId} ë°©ì„ ë‚˜ê°‘ë‹ˆë‹¤.`);
        }
        // ë¡œë¹„ë¡œ ì´ë™
        window.location.href = 'lobby.html';
      });
    });    // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
    btnSetUsername.addEventListener('click', () => {
      const inputUsername = userInput.value.trim();
      if (!inputUsername) {
        usernameError.textContent = 'ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.';
        return;
      }
      
      usernameError.textContent = '';
      
      // ì„œë²„ì— ë¨¼ì € ì—°ê²°
      connectToServer(inputUsername);
    });    function connectToServer(inputUsername) {
      try {
        //socket = io('http://money.ipdisk.co.kr:43000', {
        socket = io('https://money.ipdisk.co.kr:3000', {

          reconnectionAttempts: 5,
          timeout: 10000
        });
        
        // ì—°ê²° ì˜¤ë¥˜ ì²˜ë¦¬
        socket.on('connect_error', (error) => {
          log(`âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
          usernameError.textContent = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
        });
        
        // ì—°ê²° ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
        socket.on('connect_timeout', () => {
          log(`âš ï¸ ì„œë²„ ì—°ê²° ì‹œê°„ ì´ˆê³¼`);
          usernameError.textContent = 'ì„œë²„ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
        });
        
        socket.on('connect', () => {
          log(`âœ” ì„œë²„ ì—°ê²°ë¨: ID=${socket.id}`);
          // ì‚¬ìš©ì ì´ë¦„ ê²€ì¦ ìš”ì²­
          if(inputUsername) {
            socket.emit('set_username', { username: inputUsername });
          }
        });
        
        socket.on('username_result', (data) => {
          if (data.success) {
            username = data.username;
            isUsernameSet = true;
            userInput.disabled = true; // ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ë¹„í™œì„±í™”
            btnSetUsername.disabled = true;
            welcomeUsername.textContent = username;
            usernameSection.style.display = 'none';
            gameInterface.style.display = 'block';
            
            // ì‚¬ìš©ì ì´ë¦„ì„ localStorageì— ì €ì¥
            localStorage.setItem('username', username);
            
            log(`ì‚¬ìš©ì ì´ë¦„ ì„¤ì • ì™„ë£Œ: ${username}`);
            
            // URLì— ë°© IDê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë°©ì— ì°¸ê°€
            if (roomId) {
              log(`URLì„ í†µí•œ ë°© ${roomId} ìë™ ì°¸ê°€ ì‹œë„...`);
              setTimeout(() => {
                socket.emit('join_game', { room: roomId, player: username });
                log(`ê²Œì„ ì°¸ê°€ ìš”ì²­: ë°©=${roomId}, ì‚¬ìš©ì=${username}`);
              }, 500);
            }
          } else {
            usernameError.textContent = data.message;
            socket.disconnect();
          }
        });
        
        // ê¸°ë³¸ ì†Œì¼“ ì´ë²¤íŠ¸ ì„¤ì •
        setupSocketEvents();
      } catch (error) {
        log(`âš ï¸ ì„œë²„ ì—°ê²° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        usernameError.textContent = 'ì„œë²„ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    };    function setupSocketEvents() {
      // ê²Œì„ ê´€ë ¨ ì´ë²¤íŠ¸
      socket.on('player_joined', (data) => {
        log(`[ì°¸ê°€] ${data.player}ë‹˜ì´ ë°©ì— ì°¸ê°€í–ˆìŠµë‹ˆë‹¤.`);
        roomInfo.textContent = `ë°©: ${data.room} (${data.player_count}ëª…)`;
      });
      
      // í”Œë ˆì´ì–´ í‡´ì¥ ì´ë²¤íŠ¸
      socket.on('player_left', (data) => {
        log(`[í‡´ì¥] ${data.player}ë‹˜ì´ ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
        roomInfo.textContent = `ë°©: ${data.room} (${data.player_count}ëª…)`;
      });
      
      // ë°©ì¥ ë³€ê²½ ì´ë²¤íŠ¸
      socket.on('host_changed', (data) => {
        log(`[ì•Œë¦¼] ${data.new_host}ë‹˜ì´ ìƒˆë¡œìš´ ë°©ì¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      });
      
      // ì¹´ìš´íŠ¸ë‹¤ìš´ ì´ë²¤íŠ¸
      socket.on('countdown_started', (data) => {
        log(`[ê³µì§€] ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! ${data.seconds}ì´ˆ í›„ì— ê²Œì„ì´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.`);
      });
      
      socket.on('countdown_tick', (data) => {
        log(`[ì¹´ìš´íŠ¸ë‹¤ìš´] ê²Œì„ ì‹œì‘ê¹Œì§€ ${data.seconds_left}ì´ˆ...`);
      });
      
      socket.on('game_started', (data) => {
        log(`[ê²Œì„ ì‹œì‘] ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ì: ${data.data.players.join(', ')}`);
      });

      socket.on('game_update', (data) => {
        log(`[ê²Œì„ ì—…ë°ì´íŠ¸] ${JSON.stringify(data)}`);
        
            switch (data.type) {
              case "path":
                // showToast(`ê²½ë¡œ ì¹´ë“œê°€ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.data.x}, ${data.data.y}`, 'info');
                showToast(`${data.player}ë‹˜ì´ ê²½ë¡œ ì¹´ë“œë¥¼ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤: (${data.data.x}, ${data.data.y})`, 'info');
                animateCardPlacement(data.data.x, data.data.y)
                break;
              case "rockFail":
                showToast(`${data.player}ë‹˜ì´ ëŒì„ íŒŒê´´í–ˆìŠµë‹ˆë‹¤: ${data.data.x}, ${data.data.y}`, 'info');
                animateCardPlacement(data.data.x, data.data.y);
                break;
              case "sabotage":
                showToast(`${data.player}ë‹˜ì´ ${data.data.target}ë‹˜ì„ ë°©í•´í–ˆìŠµë‹ˆë‹¤. ë°©í•´ ìœ í˜•: ${data.data.cardType}`, 'info');
                break;
              case "repair":
                showToast(`${data.player}ë‹˜ì´ ${data.data.target}ë‹˜ì„ ìˆ˜ë¦¬í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë¦¬ ë„êµ¬: ${data.data.cardType}`, 'info');
                break;
              case "viewMap":
                // x == 10 => ì¤‘ê°„ ëª©ì ì§€ ì¹´ë“œë¥¼/ x==12 ==> ìƒë‹¨ ëª©ì ì§€ ì¹´ë“œë¥¼, x==8 ==> í•˜ë‹¨ ëª©ì ì§€ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
                if (data.data.target[0] === 10) {
                  showToast(`${data.player}ë‹˜ì´ ì¤‘ê°„ ëª©ì ì§€ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.`, 'info');
                } else if (data.data.target[0] === 12) {
                  showToast(`${data.player}ë‹˜ì´ í•˜ë‹¨ ëª©ì ì§€ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.`, 'info');
                } else if (data.data.target[0] === 8) {
                  showToast(`${data.player}ë‹˜ì´ ìƒë‹¨ ëª©ì ì§€ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.`, 'info');
                } else {
                  showToast(`${data.player}ë‹˜ì´ ì§€ë„ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤: (${data.data.x}, ${data.data.y})`, 'info');
                }
                animateCardPlacement(data.data.target[0], data.data.target[1]);
                break;
              case "discard":
                showToast(`${data.player}ë‹˜ì´ ${data.data.handNum}ë²ˆì§¸ ì¹´ë“œë¥¼ ë²„ë ¸ìŠµë‹ˆë‹¤. `,'info');
                break;
              case "endTime":
                showToast(`${data.player}ë‹˜ì˜ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì¹´ë“œë¥¼ ë²„ë¦½ë‹ˆë‹¤.`, 'info');
                break;
              case "turn_change":
                showToast(`${data.data}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤.`, 'info');
                break;
              case "rock_found":
                // showToast(`${data.player}ë‹˜ì´ ëŒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤: (${data.data.x}, ${data.data.y})`, 'info');
                animateCardPlacement(data.data.x, data.data.y);
                break;
              case 'round_end':
                // {player:self.players[player].role for player in self.players}
                console.log("################################################")
                showToast(`[ë¼ìš´ë“œ ì¢…ë£Œ] ${data.data.winner}ê°€ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.`, 'info',10);
                // í™”ë©´ ê°€ìš´ë° ì¼ì‹œì ìœ¼ë¡œ ë°•ìŠ¤ê°€ ë‚˜ì˜¤ê³  í”Œë ˆì´ì–´ ì—­í•  í‘œì‹œ

                showToast(`[í”Œë ˆì´ì–´ ì—­í• ] ${data.data.roles.map(([player, role]) => `${player}: ${role}`).join('\n')}`, 'info',10);
                console.log(`[í”Œë ˆì´ì–´ ì—­í• ] ${data.data.roles.map(([player, role]) => `${player}: ${role}`).join('\n')}`);
                break;

            }
            
      });      
      
      socket.on('private_game_update', (data) => {
        // ë§Œì•½ data.type === 'board_info'ë¼ë©´
        console.log("private_game_update ì´ë²¤íŠ¸ ë°œìƒ:", data);
          if (data.type != 'playerState') {
            log(`[ë¹„ê³µê°œ ì—…ë°ì´íŠ¸] ${JSON.stringify(data)}`);
            log(data.data.card);
            // í˜„ì¬ í”Œë ˆì´ì–´ ì˜¤ëŠ” ì´ë²¤íŠ¸
            switch (data.type) {
              case 'drawCard':
                showToast(`[ì¹´ë“œ ë“œë¡œìš°] ${data.player}ë‹˜ì´ ì¹´ë“œë¥¼ ë“œë¡œìš°í–ˆìŠµë‹ˆë‹¤.`,"info");
                break;
              case 'revealDest':{
                if (data.data.x === 10) {
                    showToast(`[ì§€ë„ ë³´ê¸°] ì¤‘ê°„ ëª©ì ì§€ ì¹´ë“œëŠ” '${data.data.cardType === -7 ? 'ê¸ˆ' : 'ëŒ'}' ì¹´ë“œì…ë‹ˆë‹¤.`,"info");
                  } else if (data.data.x === 12) {
                    showToast(`[ì§€ë„ ë³´ê¸°] í•˜ë‹¨ ëª©ì ì§€ ì¹´ë“œëŠ” '${data.data.cardType === -7 ? 'ê¸ˆ' : 'ëŒ'}' ì¹´ë“œì…ë‹ˆë‹¤.`,"info");
                  } else if (data.data.x === 8) {
                    showToast(`[ì§€ë„ ë³´ê¸°] ìƒë‹¨ ëª©ì ì§€ ì¹´ë“œëŠ” '${data.data.cardType === -7 ? 'ê¸ˆ' : 'ëŒ'}' ì¹´ë“œì…ë‹ˆë‹¤.`,"info");
                  } else {
                    showToast(`[ì§€ë„ ë³´ê¸°] ${data.player}ë‹˜ì´ ì§€ë„ ì¹´ë“œë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤: (${data.data.x}, ${data.data.y})`);
                  }
                break;
                }
              case 'roundStart':
                showToast(`[ë¼ìš´ë“œ ì‹œì‘] ${data.data.currentRound}ë²ˆì§¸ ë¼ìš´ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
                break;
              
              case 'getGold':
                showToast(`[ê¸ˆ íšë“] ${username}ë‹˜ì´ ${data.data.gold}ê°œì˜ ê¸ˆì„ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'info',10);
                break;
              case 'game_end':
                socket.emit("playerState", { room: roomId, player: username });
                const rank = Object.entries(data.data.rank)
                  .map(([player, gold]) => `${player}: ${gold}ê³¨ë“œ`)
                  .join(', ');
                  console.log("ê²Œì„ ì¢…ë£Œ ë°ì´í„°:", data.data);
                  console.log(`[ê²Œì„ ì¢…ë£Œ] ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìˆœìœ„: ${rank}`);
                showToast(`[ê²Œì„ ì¢…ë£Œ] ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìˆœìœ„: ${rank}`, 'info');
                // 
                break;
              
              default:
                log(`[ì•Œë¦¼] ë¹„ê³µì‹ ì—…ë°ì´íŠ¸: ${data.type}`);
            }



          }
          if (data.type === 'playerState') {
            console.log("private_game_update ì´ë²¤íŠ¸ì—ì„œ data.board:", data.board);
            renderGameInfo(data);
            renderPlayerInfo(data);
            renderGameBoard(data);
            return;
          }
          else if (data.type === "error") {
            const errorMsg = data.data || JSON.stringify(data);
            log(`[ì˜¤ë¥˜] ${errorMsg}`);
            
            // í† ìŠ¤íŠ¸ ì•Œë¦¼ìœ¼ë¡œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            showToast(errorMsg, 'error');

          }
        
      });


      // ì±„íŒ… ì´ë²¤íŠ¸
      socket.on('chat', (data) => {
        log(`[ì±„íŒ…] ${data.username}: ${data.message}`);
      });

      // ì˜¤ë¥˜ ì²˜ë¦¬
      socket.on('error', (err) => {
        const errorMsg = err.message || JSON.stringify(err);
        log(`[ì˜¤ë¥˜] ${errorMsg}`);
        
        // ì˜¤ë¥˜ ìœ í˜•ì— ë”°ë¥¸ ì²˜ë¦¬
        if (errorMsg.includes('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') && roomId) {
          log(`âš ï¸ ë°© ${roomId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°©ì´ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.`);
        }
      });
      
      // ì—°ê²° í•´ì œ ì´ë²¤íŠ¸
      socket.on('disconnect', (reason) => {
        log(`[ì—°ê²° í•´ì œ] ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì´ìœ : ${reason}`);
      });    }        
      document.getElementById('btnSendChat').addEventListener('click', () => {
      const room = roomId;  // URLì—ì„œ ê°€ì ¸ì˜¨ ë°© ID ì‚¬ìš©
      const msg = document.getElementById('chatMessage').value.trim();
      if (!room) {
        alert('ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if (!msg) return;
      socket.emit('chat', { room, message: msg });
      document.getElementById('chatMessage').value = '';
    });

    // Enter í‚¤ë¡œ ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !isUsernameSet) {
        btnSetUsername.click();
      }
    });

    // Enter í‚¤ë¡œ ì±„íŒ… ì „ì†¡
    document.getElementById('chatMessage').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnSendChat').click();
      }
    });
    function getCardImagePath(cardId) {
      // ì¹´ë“œ ë²ˆí˜¸ì™€ ì´ë¯¸ì§€ íŒŒì¼ëª… ë§¤í•‘
      const card_image_mapping = {
        // íŠ¹ìˆ˜ ì¹´ë“œ (ëª©ì ì§€/ì‹œì‘ì )
        "-8": "bg_playable",
        "-7": "path/14",
        "-6": "path/14",
        "-5": "path/8",
        "-4": "path/8",
        "-3": "path/6",
        "-2": "path/6",
        "-1": "path/27",
        
        // ê¸¸ ì¹´ë“œ
        "1": "path/11",
        "2": "path/13",
        "3": "path/16",
        "4": "path/1",
        "5": "path/9",
        "6": "path/0",
        "7": "path/4",
        "8": "path/7",
        
        // ë§‰íŒ ê¸¸ ì¹´ë“œ
        "9": "path/32",
        "10": "path/29",
        "11": "path/15",
        "12": "path/38",
        "13": "path/42",
        "14": "path/5",
        "15": "path/2",
        "16": "path/31",
        
        // ì•¡ì…˜ ì¹´ë“œ
        "17": "action/sabotage_m",
        "18": "action/sabotage_l",
        "19": "action/sabotage_p",
        "20": "action/repair_m",
        "21": "action/repair_l",
        "22": "action/repair_p",
        "23": "action/repair_lm",
        "24": "action/repair_pm",
        "25": "action/repair_pl",
        "26": "action/map",
        "27": "action/destroy",
      };
      
      // cardIdê°€ ë°°ì—´ì¸ ê²½ìš° ì²« ë²ˆì§¸ ìš”ì†Œ ì‚¬ìš©
      const id = Array.isArray(cardId) ? cardId[0] : cardId;
      
      // ë§¤í•‘ì—ì„œ ì´ë¯¸ì§€ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
      const imagePath = card_image_mapping[id] || "cell";
      return `/assets/${imagePath}.png`;
    }
  // ê²Œì„ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
  function renderGameInfo(gameData) {
    const gameInfoContainer = document.getElementById('privateGameViewer');
    gameInfoContainer.innerHTML = '';
    
    // ê²Œì„ ì •ë³´ ì»¨í…Œì´ë„ˆ ìƒì„±
    const infoDiv = document.createElement('div');
    
    // í˜„ì¬ ë¼ìš´ë“œ í‘œì‹œ
    const roundInfo = document.createElement('div');
    roundInfo.innerHTML = `<strong>í˜„ì¬ ë¼ìš´ë“œ:</strong> ${gameData.data.round}`;
    infoDiv.appendChild(roundInfo);
    
    // í˜„ì¬ í”Œë ˆì´ì–´ ìˆœì„œ í‘œì‹œ
    const playerOrderDiv = document.createElement('div');
    playerOrderDiv.innerHTML = '<strong>í”Œë ˆì´ì–´ ìˆœì„œ:</strong> ';
    
    // í”Œë ˆì´ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const playersList = Object.keys(gameData.players);
    
    // í˜„ì¬ í”Œë ˆì´ì–´ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
    playersList.forEach(playerName => {
      const playerSpan = document.createElement('span');
      playerSpan.textContent = playerName;
      
      // í˜„ì¬ ì°¨ë¡€ í”Œë ˆì´ì–´ëŠ” í•˜ì´ë¼ì´íŠ¸
      if (playerName === gameData.currentPlayer) {
        playerSpan.style.backgroundColor = '#ffeb3b';
        playerSpan.style.fontWeight = 'bold';
        playerSpan.style.padding = '2px 5px';
        playerSpan.style.borderRadius = '3px';
      }
      
      playerOrderDiv.appendChild(playerSpan);
      playerOrderDiv.appendChild(document.createTextNode(' '));
    });
    
    infoDiv.appendChild(playerOrderDiv);
    
    // ì¹´ë“œë± ì •ë³´ í‘œì‹œ (ìˆ«ìë§Œ, ì´ë¯¸ì§€ëŠ” ìƒëµ)
    const deckInfo = document.createElement('div');
    deckInfo.innerHTML = `<strong>ë± ë‚¨ì€ ì¹´ë“œ:</strong> ${gameData.data.deckCount}ì¥`;
    infoDiv.appendChild(deckInfo);
    
    // // ê³¨ë“œ ì¹´ë“œ ì •ë³´
    // const goldInfo = document.createElement('div');
    // goldInfo.innerHTML = `<strong>ê³¨ë“œ ì¹´ë“œ:</strong> ${gameData.goldDeck.length}ì¥`;
    // infoDiv.appendChild(goldInfo);
    
    gameInfoContainer.appendChild(infoDiv);
  }
  // í”Œë ˆì´ì–´ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
  function renderPlayerInfo(gameData) {
    const playerInfoContainer = document.getElementById('privateHandViewer');
    playerInfoContainer.innerHTML = '';
    
    // í”Œë ˆì´ì–´ ì •ë³´ ì»¨í…Œì´ë„ˆ
    const playersDiv = document.createElement('div');
    playersDiv.style.display = 'flex';
    playersDiv.style.flexDirection = 'column';
    playersDiv.style.gap = '10px';
    
    // í”Œë ˆì´ì–´ ëª©ë¡ì„ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸°
    const allPlayers = Object.values(gameData.players);
    let playersList = [];
    
    // í˜„ì¬ ì‚¬ìš©ìì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
    const currentUserIndex = allPlayers.findIndex(player => player.name === username);
    
    // ìˆœì„œ ì¬ë°°ì¹˜: í˜„ì¬ ì‚¬ìš©ìê°€ ë§ˆì§€ë§‰ì— ì˜¤ê³ , ê·¸ ë‹¤ìŒë¶€í„° ìˆœí™˜ ë°°ì¹˜
    if (currentUserIndex !== -1) {
      // í˜„ì¬ ì‚¬ìš©ìì˜ ë‹¤ìŒ í”Œë ˆì´ì–´ë¶€í„° ì‹œì‘
      const afterCurrent = allPlayers.slice(currentUserIndex + 1);
      // í˜„ì¬ ì‚¬ìš©ìì˜ ì´ì „ í”Œë ˆì´ì–´ë“¤
      const beforeCurrent = allPlayers.slice(0, currentUserIndex);
      // í˜„ì¬ ì‚¬ìš©ìë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í”Œë ˆì´ì–´ë“¤ (ìˆœí™˜ ìˆœì„œë¡œ)
      const othersInOrder = [...afterCurrent, ...beforeCurrent];
      // í˜„ì¬ ì‚¬ìš©ìë¥¼ ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€
      playersList = [...othersInOrder, allPlayers[currentUserIndex]];
    } else {
      playersList = allPlayers;
    }
    
    // ê° í”Œë ˆì´ì–´ ì •ë³´ í‘œì‹œ
    playersList.forEach(player => {
      const playerDiv = document.createElement('div');
      playerDiv.classList.add('player-div');
      playerDiv.dataset.playerName = player.name;
      playerDiv.style.padding = '5px';
      playerDiv.style.border = '1px solid #ddd';
      playerDiv.style.borderRadius = '5px';
      
      // í˜„ì¬ ì°¨ë¡€ í”Œë ˆì´ì–´ëŠ” í•˜ì´ë¼ì´íŠ¸
      if (player.name === gameData.currentPlayer) {
        playerDiv.style.backgroundColor = '#f0f8ff';
        playerDiv.style.borderColor = '#007bff';
      }
      
      // í”Œë ˆì´ì–´ ê¸°ë³¸ ì •ë³´
      const infoDiv = document.createElement('div');
      infoDiv.innerHTML = `<strong>${player.name}</strong> | ì—­í• : ${player.role} || ê³¨ë“œ: ${player.gold}\n mineCart: ${player.limit.mineCart ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'} || pickaxe: ${player.limit.pickaxe ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'} || lantern: ${player.limit.lantern ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'}`;
      // infoDiv.innerHTML = `<strong>${player.name}</strong> | ì—­í• : ${player.role} || ê³¨ë“œ: ${player.gold}\n mineCart: ${player.limit.mineCart ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'} || pickaxe: ${player.limit.pickaxe ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'} || lantern: ${player.limit.lantern ? '<span style="background-color: #ff4c4c; color: white; padding: 2px 5px; border-radius: 3px; font-weight: bold;">ì œí•œ</span>' : 'ì •ìƒ'}`;
      playerDiv.appendChild(infoDiv);
      
      //ë“œë ë¦¬ìŠ¤ë„ˆ
      playerDiv.addEventListener('dragover', function(e) {
        e.preventDefault(); // ë“œë¡­ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ ê¸°ë³¸ ë™ì‘ ë°©ì§€
      });
      playerDiv.addEventListener('drop', function(e) {
        e.preventDefault();
        const cardData = JSON.parse(e.dataTransfer.getData('text/plain'));
        
        // ì¹´ë“œ ì •ë³´ì™€ í”Œë ˆì´ì–´ ì´ë¦„ ì½˜ì†”ì— ì¶œë ¥
        console.log(`ë“œë¡­ëœ ì¹´ë“œ: ${JSON.stringify(cardData)}, í”Œë ˆì´ì–´: ${player.name}`);
        
        // ì„œë²„ë¡œ ì¹´ë“œ ë“œë¡­ ì´ë²¤íŠ¸ ì „ì†¡
        if (cardData.cardType === 'sabotage') {
          socket.emit('chat', {
          room: getRoomIdFromUrl(),
          message:JSON.stringify({
            type: 'sabotage',
            data: {
              target:player.name,
              handNum: cardData.handIndex
            }
          })
        });
      }
        else if (cardData.cardType === 'repair') {
          // ë§Œì•½ cardData.toolì˜  ì •ë³´ê°€ a,bì™€ ê°™ì´ ë‘ê°€ì§€ë¼ë©´ ëª¨ë‹¬ ë„ì›Œì„œ ì„ íƒí•˜ê²Œ í•˜ê¸° ì´ë•Œ ëª¨ë‹¬ì— ë‘ ë²„íŠ¼ì„ ë§Œë“¤ê³  ê°ê° toolì„ ë„£ì–´ì„œ ì„ íƒí•˜ê²Œ
          let toolChoice = cardData.tool; // ê¸°ë³¸ê°’ì€ í˜„ì¬ íˆ´
          if (cardData.tool.length > 1) {
            // íˆ´ ì„ íƒ ëª¨ë‹¬ ìƒì„±
            const toolModal = document.createElement('div');
            toolModal.style.position = 'fixed';
            toolModal.style.top = '50%';
            toolModal.style.left = '50%';
            toolModal.style.transform = 'translate(-50%, -50%)';
            toolModal.style.backgroundColor = '#fff';
            toolModal.style.padding = '20px';
            toolModal.style.border = '1px solid #ddd';
            toolModal.style.borderRadius = '5px';
            toolModal.style.zIndex = '1000';
            toolModal.innerHTML = `
              <h3>íˆ´ ì„ íƒ</h3>
              <p>ì–´ë–¤ íˆ´ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
              <div style="display: flex; gap: 10px;">
                ${cardData.tool.map(tool => `<button class="tool-button" data-tool="${tool}">${tool}</button>`).join('')}
              </div>
            `;
            document.body.appendChild(toolModal);
            // íˆ´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            const toolButtons = toolModal.querySelectorAll('.tool-button');
            toolButtons.forEach(button => {
              button.addEventListener('click', function() {
                toolChoice = this.getAttribute('data-tool'); // ì„ íƒí•œ íˆ´
                console.log(`ì„ íƒí•œ íˆ´: ${toolChoice}`);
                // ëª¨ë‹¬ ë‹«ê¸°
                document.body.removeChild(toolModal);
                socket.emit('chat', {
                  room: getRoomIdFromUrl(),
                  message: JSON.stringify({
                    type: 'repair',
                    data: {
                      target: player.name,
                      handNum: cardData.handIndex,
                      tool: toolChoice // íˆ´ ì •ë³´ ì¶”ê°€
                    }
                  })
                });
              });
            });
            
          }
          else {
            // íˆ´ì´ í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš° ë°”ë¡œ ì„œë²„ë¡œ ì „ì†¡
            socket.emit('chat', {
            room: getRoomIdFromUrl(),
            message: JSON.stringify({
              type: 'repair',
              data: {
                target: player.name,
                handNum: cardData.handIndex,
                tool: cardData.tool[0] // íˆ´ ì •ë³´ ì¶”ê°€
              }
            })
          });
          }
          
        }
      });
      
      // í”Œë ˆì´ì–´ í•¸ë“œ ì¹´ë“œ í‘œì‹œ
      const handDiv = document.createElement('div');
      handDiv.style.display = 'flex';
      handDiv.style.gap = '5px';
      handDiv.style.marginTop = '5px';
      handDiv.style.overflowX = 'auto';
      
      // ê° ì¹´ë“œ ì´ë¯¸ì§€ í‘œì‹œ
      player.hand.forEach((card,index) => {
      const cardImg = document.createElement('img');
      cardImg.src = getCardImagePath(card.cardId);
      cardImg.style.width = '80px';
      cardImg.style.height = '120px';
      cardImg.style.border = '1px solid #ccc';
      if (player.name === username) {
        // ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        cardImg.draggable = true;
        cardImg.style.cursor = 'grab'; // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì»¤ì„œë¡œ ë³€ê²½
        // ë“œë˜ê·¸ ì‹œì‘ ì´ë²¤íŠ¸
        cardImg.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            cardId: card.cardId,
            cardType: card.cardType,
            reverse: card.reverse,
            handIndex: index, // ì¸ë±ìŠ¤ ì •ë³´ ì¶”ê°€
            tool:card.tool
          }));
          e.dataTransfer.effectAllowed = 'move';
          addTouchEventListeners(cardImg, card, index);
        });
    }
    else {
        // ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì¹´ë“œëŠ” ë“œë˜ê·¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        cardImg.draggable = false; // ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì¹´ë“œëŠ” ë“œë˜ê·¸ ë¶ˆê°€ëŠ¥
      }
      
      // ì¹´ë“œ íšŒì „ ë¡œì§ ìˆ˜ì •
      // 1-16ë²ˆ ì¹´ë“œ(path í´ë”)ì™€ 17-27ë²ˆ ì¹´ë“œ(action í´ë”)ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë’¤ì§‘ì–´ì„œ í‘œì‹œ
      const cardIdNum = Array.isArray(card.cardId) ? card.cardId[0] : card.cardId;
      const needsDefaultRotation = (cardIdNum >= 1 && cardIdNum <= 16);
      
      // reverseê°€ trueë©´ íšŒì „(ë˜ëŠ” íšŒì „ ì·¨ì†Œ)
      if (!needsDefaultRotation){}
      else if (card.reverse) {
        cardImg.style.transform = 'rotate(180deg)';
      }
      
      // ì¹´ë“œ íˆ´íŒ (ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ì¹´ë“œ ì •ë³´ í‘œì‹œ)
      cardImg.title = `ID: ${card.cardId}, íƒ€ì…: ${card.cardType}`;
      if (card.tool) {
        cardImg.title += `, íˆ´: ${card.tool}`;
      }
      handDiv.appendChild(cardImg);
    });
      
      playerDiv.appendChild(handDiv);
      playersDiv.appendChild(playerDiv);
    });
    
    playerInfoContainer.appendChild(playersDiv);

    // ë²„ë¦¬ê¸° êµ¬ì—­ ë° ëŒë¦¬ê¸° êµ¬ì—­ ì»¨í…Œì´ë„ˆ
    const actionAreasContainer = document.createElement('div');
    actionAreasContainer.style.display = 'flex';
    actionAreasContainer.style.gap = '10px';
    actionAreasContainer.style.marginTop = '20px';

    // ë²„ë¦¬ê¸° êµ¬ì—­ ìƒì„±
    const discardArea = document.createElement('div');
    discardArea.style.flex = '1';
    discardArea.style.padding = '20px 10px';
    discardArea.style.minHeight = '60px';
    discardArea.style.border = '1px solid #ddd';
    discardArea.style.borderRadius = '5px';
    discardArea.style.backgroundColor = '#f8f9fa';
    discardArea.style.display = 'flex';
    discardArea.style.alignItems = 'center';
    discardArea.style.justifyContent = 'center';
    discardArea.style.textAlign = 'center';
    discardArea.style.fontSize = '16px';
    discardArea.style.cursor = 'pointer';
    discardArea.innerHTML = 'ğŸ—‘ï¸ <br>ì“°ë ˆê¸°í†µ<br>(ì—¬ê¸°ì— ì¹´ë“œë¥¼ ë“œë¡­í•˜ì„¸ìš”)';
    discardArea.classList.add('discard-area');

    // ëŒë¦¬ê¸° êµ¬ì—­ ìƒì„±
    const reverseArea = document.createElement('div');
    reverseArea.style.flex = '1';
    reverseArea.style.padding = '20px 10px';
    reverseArea.style.minHeight = '60px';
    reverseArea.style.border = '1px solid #ddd';
    reverseArea.style.borderRadius = '5px';
    reverseArea.style.backgroundColor = '#f0f7ff';
    reverseArea.style.display = 'flex';
    reverseArea.style.alignItems = 'center';
    reverseArea.style.justifyContent = 'center';
    reverseArea.style.textAlign = 'center';
    reverseArea.style.fontSize = '16px';
    reverseArea.style.cursor = 'pointer';
    reverseArea.innerHTML = 'ğŸ”„ <br>ëŒë¦¬ê¸°<br>(ì—¬ê¸°ì— ì¹´ë“œë¥¼ ë“œë¡­í•˜ì„¸ìš”)';
    reverseArea.classList.add('reverse-area');

    // ë²„ë¦¬ê¸° ì˜ì—­ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸
    discardArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      discardArea.style.backgroundColor = '#e0f7fa';
    });

    discardArea.addEventListener('dragleave', function() {
      discardArea.style.backgroundColor = '#f8f9fa';
    });

    discardArea.addEventListener('drop', function(e) {
      e.preventDefault();
      discardArea.style.backgroundColor = '#f8f9fa';
      const cardData = JSON.parse(e.dataTransfer.getData('text/plain'));
      
      // ì¹´ë“œ ì •ë³´ì™€ í”Œë ˆì´ì–´ ì´ë¦„ ì½˜ì†”ì— ì¶œë ¥
      console.log(`ë“œë¡­ëœ ì¹´ë“œ: ${JSON.stringify(cardData)}, í”Œë ˆì´ì–´: ${username}`);
      
      // ì„œë²„ë¡œ ì¹´ë“œ ë²„ë¦¬ê¸° ì´ë²¤íŠ¸ ì „ì†¡
      socket.emit('chat', {
        room: getRoomIdFromUrl(),
        message: JSON.stringify({
          type: 'discard',
          data: {
            handNum: cardData.handIndex
          }
        })
      });
    });

    // ëŒë¦¬ê¸° ì˜ì—­ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸
    reverseArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      reverseArea.style.backgroundColor = '#d4e6ff';
    });

    reverseArea.addEventListener('dragleave', function() {
      reverseArea.style.backgroundColor = '#f0f7ff';
    });

    reverseArea.addEventListener('drop', function(e) {
      e.preventDefault();
      reverseArea.style.backgroundColor = '#f0f7ff';
      const cardData = JSON.parse(e.dataTransfer.getData('text/plain'));
      
      // ì¹´ë“œ ì •ë³´ ì½˜ì†”ì— ì¶œë ¥
      console.log(`ëŒë¦´ ì¹´ë“œ: ${JSON.stringify(cardData)}`);
      
      // ì„œë²„ë¡œ ì¹´ë“œ ëŒë¦¬ê¸° ì´ë²¤íŠ¸ ì „ì†¡
      socket.emit('chat', {
        room: getRoomIdFromUrl(),
        message: JSON.stringify({
          type: 'reversePath',
          data: {
            handNum: cardData.handIndex
          }
        })
      });
      
      // ì‹œê°ì  í”¼ë“œë°± (ì• ë‹ˆë©”ì´ì…˜)
      reverseArea.innerHTML = 'ğŸ”„ <br>ëŒë¦¬ëŠ” ì¤‘...';
      setTimeout(() => {
        reverseArea.innerHTML = 'ğŸ”„ <br>ëŒë¦¬ê¸°<br>(ì—¬ê¸°ì— ì¹´ë“œë¥¼ ë“œë¡­í•˜ì„¸ìš”)';
      }, 1000);
    });

    // ì•¡ì…˜ ì˜ì—­ë“¤ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
    actionAreasContainer.appendChild(discardArea);
    actionAreasContainer.appendChild(reverseArea);

    // ì•¡ì…˜ ì˜ì—­ ì»¨í…Œì´ë„ˆë¥¼ playerInfoContainerì— ì¶”ê°€
    playerInfoContainer.appendChild(actionAreasContainer);
  }


    // ê²Œì„ ë³´ë“œ í‘œì‹œ í•¨ìˆ˜
  function renderGameBoard(gameData) {
    // ë³´ë“œ ë‚´ìš© ë¹„êµë¥¼ ìœ„í•´ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
    const boardStr = JSON.stringify(gameData.board);
    const prevBoardStr = JSON.stringify(GameBoardInfo);
    
    if (prevBoardStr === boardStr) {
      console.log("ê²Œì„ ë³´ë“œ ì •ë³´ê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
      return; // ê²Œì„ ë³´ë“œ ì •ë³´ê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
    }
    
    console.log("ê²Œì„ ë³´ë“œ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    // ê¹Šì€ ë³µì‚¬ë¥¼ í†µí•´ ë³´ë“œ ì •ë³´ ì €ì¥ (ì°¸ì¡° ë³µì‚¬ê°€ ì•„ë‹Œ)
    GameBoardInfo = JSON.parse(JSON.stringify(gameData.board));
    
    const boardContainer = document.getElementById('privateMessageViewer');
    
    // í˜„ì¬ ë“œë˜ê·¸ ì»¨í…Œì´ë„ˆì˜ ìœ„ì¹˜ ì •ë³´ ì €ì¥
    const currentDragContainer = document.getElementById('draggableBoard');
    if (currentDragContainer) {
      const transform = currentDragContainer.style.transform;
      if (transform) {
        // translate(Xpx, Ypx) scale(Z) í˜•ì‹ì—ì„œ ê°’ ì¶”ì¶œ
        const translateMatch = transform.match(/translate\((-?\d+(\.\d+)?)px,\s*(-?\d+(\.\d+)?)px\)/);
        const scaleMatch = transform.match(/scale\((\d+(\.\d+)?)\)/);
        
        if (translateMatch) {
          boardViewState.currentX = parseFloat(translateMatch[1]);
          boardViewState.currentY = parseFloat(translateMatch[3]);
        }
        
        if (scaleMatch) {
          boardViewState.scale = parseFloat(scaleMatch[1]);
        }
      }
    }
    
    boardContainer.innerHTML = '';
    
    // ì™¸ë¶€ ì»¨í…Œì´ë„ˆ ìƒì„±
    const outerContainer = document.createElement('div');
    outerContainer.style.position = 'relative';
    outerContainer.style.width = '100%';
    outerContainer.style.height = '800px';
    outerContainer.style.overflow = 'hidden';
    
    // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë³´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
    const dragContainer = document.createElement('div');
    dragContainer.style.position = 'absolute';
    dragContainer.style.cursor = 'move';
    dragContainer.id = 'draggableBoard';
    
    // ë³´ë“œ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
    const gridContainer = document.createElement('div');
    gridContainer.style.display = 'grid';
    gridContainer.style.gridTemplateColumns = 'repeat(22, 80px)';
    gridContainer.style.gridTemplateRows = 'repeat(22, 120px)';
    gridContainer.style.gap = '2px';
    
    // ë³´ë“œ ë°°ì—´ ìƒì„± (22x22)
    const boardArray = Array(22).fill().map(() => Array(22).fill(null));
    
    // ë³´ë“œ ë°ì´í„°ë¥¼ ë°°ì—´ì— ë§¤í•‘
    gameData.board.forEach(cell => {
      boardArray[cell.x][cell.y] = cell;
    });
    
    // ê·¸ë¦¬ë“œ ì…€ ìƒì„± (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    for (let x = 0; x < 22; x++) {
      for (let y = 0; y < 22; y++) {
      const cell = document.createElement('div');
      cell.classList.add('board-cell');
      cell.dataset.x = x;
      cell.dataset.y = y;
      
      cell.style.width = '80px';
      cell.style.height = '120px';
      cell.style.backgroundColor = '#f5f5f5';
      cell.style.border = '1px solid #ddd';


      cell.addEventListener('dragover', function(e) {
        e.preventDefault(); // ë“œë¡­ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ ê¸°ë³¸ ë™ì‘ ë°©ì§€
        });
        
        cell.addEventListener('drop', function(e) {
          e.preventDefault();
          const cardData = JSON.parse(e.dataTransfer.getData('text/plain'));
          
          // ì¹´ë“œ ì •ë³´ì™€ ìœ„ì¹˜ ì½˜ì†”ì— ì¶œë ¥
          console.log('ì¹´ë“œ ë†“ê¸°:', {
            room: getRoomIdFromUrl(),
            player: username,
            action: {
              type: 'path',
              data: {
                x: x,
                y: y,
                handNum: cardData.handIndex
              }
            }
          });
          // ì„œë²„ì— ì¹´ë“œ ë†“ê¸° ì´ë²¤íŠ¸ ì „ì†¡
          if (cardData.cardType === 'path') {
            socket.emit('chat', {
            room: getRoomIdFromUrl(),
            message:JSON.stringify({
              type: 'path',
              data: {
                x: x,
                y: y,
                handNum: cardData.handIndex
              }
            })
          });}
          else if (cardData.cardType === 'rockFail') {
            socket.emit('chat', {
            room: getRoomIdFromUrl(),
            message:JSON.stringify({
              type: 'rockFail',
              data: {
                x: x,
                y: y,
                handNum: cardData.handIndex
              }
            })
          });}
          else if (cardData.cardType === 'viewMap') {
            socket.emit('chat', {
            room: getRoomIdFromUrl(),
            message:JSON.stringify({
              type: 'viewMap',
              data: {
                x: x,
                y: y,
                handNum: cardData.handIndex
              }
            })
            });}
          // ì‹œê°ì  í”¼ë“œë°± (ì…€ ê°•ì¡°)
          cell.style.backgroundColor = '#e0f7fa';
          setTimeout(() => {
            cell.style.backgroundColor = '#f5f5f5';
          }, 300);
        });
      


      
      // ì…€ì— ì¹´ë“œê°€ ìˆëŠ” ê²½ìš°
      if (boardArray[x][y]) {
        const cardImg = document.createElement('img');
        cardImg.src = getCardImagePath(boardArray[x][y].cardId);
        if (boardArray[x][y].cardId === -6 || boardArray[x][y].cardId === -2 || boardArray[x][y].cardId === -4) {
          cardImg.src = getCardImagePath(boardArray[x][y].cardId-1); // ëª©ì ì§€ ì¹´ë“œ ì´ë¯¸ì§€ë¡œ ë³€ê²½
          cardImg.style.opacity = '0.5'; // ëª©ì ì§€ ì¹´ë“œì˜ ê²½ìš° ë°˜íˆ¬ëª… ì²˜ë¦¬
        }
        cardImg.style.width = '100%';
        cardImg.style.height = '100%';
        cardImg.style.objectFit = 'cover';
        
        // ì¹´ë“œ íšŒì „ ë¡œì§ ìˆ˜ì •
        const cardIdNum = Array.isArray(boardArray[x][y].cardId) ? boardArray[x][y].cardId[0] : boardArray[x][y].cardId;
        const needsDefaultRotation = (cardIdNum >= 1 && cardIdNum <= 27);
        
        // reverseê°€ trueë©´ íšŒì „(ë˜ëŠ” íšŒì „ ì·¨ì†Œ)
        console.log("card:",boardArray[x][y].cardId,"needsDefaultRotation:", needsDefaultRotation, "reverse:", boardArray[x][y].reverse);
        if ((boardArray[x][y].reverse)) {
          cardImg.style.transform = 'rotate(180deg)';
        }
        
        cell.appendChild(cardImg);
        
        // ì¢Œí‘œ íˆ´íŒ ì¶”ê°€
        
      } else {
        // ë¹ˆ ê³µê°„ì€ ê¸°ë³¸ cell ì´ë¯¸ì§€ë¡œ ì±„ìš°ê¸°
        const emptyImg = document.createElement('img');
        emptyImg.src = '/assets/cell.png';
        emptyImg.style.width = '100%';
        emptyImg.style.height = '100%';
        emptyImg.style.opacity = '0.3';
        cell.appendChild(emptyImg);
      }
      cell.title = `X: ${x}, Y: ${y}`;
      gridContainer.appendChild(cell);
    }
  }
  
  dragContainer.appendChild(gridContainer);
  outerContainer.appendChild(dragContainer);
  boardContainer.appendChild(outerContainer);
  
  // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
  // ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì • ë° ì´ì „ ì‹œì  ë³µì›
  setupDraggableBoard(dragContainer, boardViewState);
}

// ë³´ë“œ ë“œë˜ê·¸ ê¸°ëŠ¥ ìˆ˜ì •
function setupDraggableBoard(element, viewState = null) {
  let isDragging = false;
  let startX, startY;
  let initialX = 0, initialY = 0;
  let currentX = 0, currentY = 0;
  let scale = 1; // í™•ëŒ€/ì¶•ì†Œ ë¹„ìœ¨
  
  // ì •í™•í•œ ë³´ë“œ í¬ê¸° ê³„ì‚° (80px x 120px ì…€ í¬ê¸° ê¸°ì¤€)
  const cellSize = 80;
  const cellHeight = 120; // ì„¸ë¡œ ì…€ í¬ê¸°
  const gapSize = 2;
  const boardWidth = 22 * cellSize + 21 * gapSize;
  const boardHeight = 22 * cellHeight + 21 * gapSize;
  
  // ë¶€ëª¨ ìš”ì†Œì˜ í¬ê¸°
  const parentWidth = element.parentElement.offsetWidth;
  const parentHeight = element.parentElement.offsetHeight;
  
  // ì´ì „ ì‹œì  ì •ë³´ê°€ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ì´ˆê¸°í™”
  if (viewState && viewState.currentX !== null) {
    currentX = viewState.currentX;
    currentY = viewState.currentY;
    scale = viewState.scale || 1;
  } else {
    // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • - ì¤‘ì•™ ì •ë ¬
    currentX = (parentWidth - boardWidth) / 2;
    currentY = (parentHeight - boardHeight) / 2;
  }
  
  updatePosition();
  
  // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  element.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);
  
  // í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë°”ì¼ ì§€ì›)
  element.addEventListener('touchstart', dragStart);
  document.addEventListener('touchmove', drag);
  document.addEventListener('touchend', dragEnd);
  
  // ë“œë˜ê·¸ ì‹œì‘
  function dragStart(e) {
    e.preventDefault();
    
    if (e.type === 'touchstart') {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    } else {
      startX = e.clientX;
      startY = e.clientY;
    }
    
    initialX = currentX;
    initialY = currentY;
    isDragging = true;
    
    // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ì»¤ì„œ ë³€ê²½
    element.style.cursor = 'grabbing';
  }
  
  // ë“œë˜ê·¸ ì¤‘
  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    let currentPosX, currentPosY;
    
    if (e.type === 'touchmove') {
      currentPosX = e.touches[0].clientX;
      currentPosY = e.touches[0].clientY;
    } else {
      currentPosX = e.clientX;
      currentPosY = e.clientY;
    }
    
    // ì´ë™ ê±°ë¦¬ ê³„ì‚°
    const deltaX = currentPosX - startX;
    const deltaY = currentPosY - startY;
    
    currentX = initialX + deltaX;
    currentY = initialY + deltaY;
    
    updatePosition();
  }
  
  // ë“œë˜ê·¸ ì¢…ë£Œ
  function dragEnd() {
    isDragging = false;
    initialX = currentX;
    initialY = currentY;
    
    // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ì»¤ì„œ ë³µì›
    element.style.cursor = 'move';
  }
  
  // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
  // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì •
  function updatePosition() {
    // í™•ëŒ€/ì¶•ì†Œê°€ ì¶”ê°€ëœ íŠ¸ëœìŠ¤í¼
    element.style.transform = `translate(${currentX}px, ${currentY}px) scale(${scale})`;
    element.style.transformOrigin = 'top left';
    
    // ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
    boardViewState.currentX = currentX;
    boardViewState.currentY = currentY;
    boardViewState.scale = scale;
  }
  
  // íœ  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥)
  element.addEventListener('wheel', function(e) {
    e.preventDefault();
    
    const zoomIntensity = 0.1;
    const wheel = e.deltaY < 0 ? 1 : -1;
    const zoom = Math.exp(wheel * zoomIntensity);
    
    // í™•ëŒ€/ì¶•ì†Œ ì œí•œ (0.5~2.0 ë°°ìœ¨ë¡œ ì œí•œ)
    const newScale = Math.min(Math.max(scale * zoom, 0.5), 2.0);
    
    // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ
    const rect = element.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    // ìƒˆ ìœ„ì¹˜ ê³„ì‚° (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ)
    currentX = mouseX - (mouseX - currentX) * newScale / scale;
    currentY = mouseY - (mouseY - currentY) * newScale / scale;
    
    scale = newScale;
    updatePosition();
  });
}
// í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
  function showToast(message, type = 'error', duration = 6) {
    // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìš”ì†Œ
    const container = document.getElementById('toast-container');
    
    // ìƒˆë¡œìš´ í† ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±
    const toast = document.createElement('div');
    toast.style.backgroundColor = type === 'error' ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 128, 0, 0.8)';
    toast.style.color = 'white';
    toast.style.padding = '12px 20px';
    toast.style.borderRadius = '5px';
    toast.style.marginBottom = '10px';
    toast.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    toast.style.transition = 'all 0.3s ease-in-out';
    toast.innerHTML = `
      <div style="display: flex; align-items: center;">
        <span style="margin-right: 10px; font-size: 20px;">${type === 'error' ? 'âš ï¸' : 'âœ…'}</span>
        <span style="font-size: 20px;">${message}</span>
      </div>
    `;
    
    // í† ìŠ¤íŠ¸ ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
    container.appendChild(toast);
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ í‘œì‹œ ì• ë‹ˆë©”ì´ì…˜
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 50);
    
    // ì¼ì • ì‹œê°„ í›„ í† ìŠ¤íŠ¸ ì œê±°
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      
      // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ ìš”ì†Œ ì œê±°
      setTimeout(() => {
        container.removeChild(toast);
      }, 300);
    }, duration*1000);
  }







  // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œ ì •ë³´ ì €ì¥
let draggedCardData = null;
let touchDragElement = null;
let originalElement = null;
let startTouchX, startTouchY;

// ì¹´ë“œ ì´ë¯¸ì§€ì— í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
function addTouchEventListeners(cardImg, card, index) {
  cardImg.addEventListener('touchstart', function(e) {
    // ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘ ë°©ì§€
    e.preventDefault();
    
    // ë“œë˜ê·¸ ì‹œì‘ ìœ„ì¹˜ ì €ì¥
    const touch = e.touches[0];
    startTouchX = touch.clientX;
    startTouchY = touch.clientY;
    
    // ë“œë˜ê·¸ ë°ì´í„° ì €ì¥
    draggedCardData = {
      cardId: card.cardId,
      cardType: card.cardType,
      reverse: card.reverse,
      handIndex: index,
      tool: card.tool
    };
    
    // ì‹œê°ì  í”¼ë“œë°± - ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œ ë³µì œ
    originalElement = this;
    touchDragElement = this.cloneNode(true);
    touchDragElement.style.position = 'fixed';
    touchDragElement.style.opacity = '0.8';
    touchDragElement.style.zIndex = '10000';
    touchDragElement.style.pointerEvents = 'none';
    touchDragElement.style.width = '60px'; // ì¢€ ë” ì‘ê²Œ í‘œì‹œ
    touchDragElement.style.height = '90px';
    touchDragElement.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
    
    // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
    touchDragElement.style.left = (touch.clientX - 30) + 'px';
    touchDragElement.style.top = (touch.clientY - 45) + 'px';
    
    document.body.appendChild(touchDragElement);
    
    // ì›ë³¸ ì¹´ë“œ ë°˜íˆ¬ëª…í•˜ê²Œ
    this.style.opacity = '0.5';
  });

  // í„°ì¹˜ ì´ë™ ì²˜ë¦¬
  document.addEventListener('touchmove', function(e) {
    if (!touchDragElement || !draggedCardData) return;
    
    const touch = e.touches[0];
    touchDragElement.style.left = (touch.clientX - 30) + 'px';
    touchDragElement.style.top = (touch.clientY - 45) + 'px';
  });

  // í„°ì¹˜ ì¢…ë£Œ ì²˜ë¦¬
  document.addEventListener('touchend', function(e) {
    if (!touchDragElement || !draggedCardData) return;
    
    // ë“œë˜ê·¸ ìš”ì†Œ ì œê±°
    document.body.removeChild(touchDragElement);
    
    // ì›ë³¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³µì›
    if (originalElement) {
      originalElement.style.opacity = '1';
    }
    
    // ë“œë¡­ ìœ„ì¹˜ ìš”ì†Œ í™•ì¸ (í„°ì¹˜ ì¢…ë£Œ ìœ„ì¹˜ì— ìˆëŠ” ì—˜ë¦¬ë¨¼íŠ¸)
    const touch = e.changedTouches[0];
    const dropElement = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (dropElement) {
      // ë“œë¡­ ì˜ì—­ ì‹ë³„ (í”Œë ˆì´ì–´ ì˜ì—­, ë³´ë“œ ì…€, ë²„ë¦¬ê¸° ì˜ì—­ ë“±)
      const playerDiv = findParentWithClass(dropElement, 'player-div');
      const boardCell = findParentWithClass(dropElement, 'board-cell');
      const discardArea = findParentWithClass(dropElement, 'discard-area');

      
      // í”Œë ˆì´ì–´ ì˜ì—­ì— ë“œë¡­í•œ ê²½ìš°
      if (playerDiv) {
        const playerName = playerDiv.dataset.playerName;
        handleCardDropOnPlayer(draggedCardData, playerName);
      } 
      // ë³´ë“œ ì…€ì— ë“œë¡­í•œ ê²½ìš°
      else if (boardCell) {
        const x = parseInt(boardCell.dataset.x);
        const y = parseInt(boardCell.dataset.y);
        handleCardDropOnBoard(draggedCardData, x, y);
      }
      // ë²„ë¦¬ê¸° ì˜ì—­ì— ë“œë¡­í•œ ê²½ìš°
      else if (discardArea) {
        handleCardDiscard(draggedCardData);
      }
    }
    
    // ë³€ìˆ˜ ì´ˆê¸°í™”
    touchDragElement = null;
    draggedCardData = null;
    originalElement = null;
  });
}

// ë¶€ëª¨ ìš”ì†Œ ì°¾ê¸° í—¬í¼ í•¨ìˆ˜
function findParentWithClass(element, className) {
  while (element) {
    if (element.classList && element.classList.contains(className)) {
      return element;
    }
    element = element.parentElement;
  }
  return null;
}

// ë“œë¡­ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
function handleCardDropOnPlayer(cardData, playerName) {
  console.log(`ì¹´ë“œ ${cardData.cardId}ë¥¼ í”Œë ˆì´ì–´ ${playerName}ì—ê²Œ ë“œë¡­`);
  
  // ì‚¬ë³´íƒ€ì£¼/ìˆ˜ë¦¬ ì¹´ë“œ ì²˜ë¦¬
  if (cardData.cardType === 'sabotage') {
    socket.emit('chat', {
      room: getRoomIdFromUrl(),
      message: JSON.stringify({
        type: 'sabotage',
        data: {
          target: playerName,
          handNum: cardData.handIndex
        }
      })
    });
  } else if (cardData.cardType === 'repair') {
    // í˜„ì¬ ì½”ë“œì™€ ë™ì¼í•œ ì²˜ë¦¬...
  }
}

function handleCardDropOnBoard(cardData, x, y) {
  console.log(`ì¹´ë“œ ${cardData.cardId}ë¥¼ ë³´ë“œ ì¢Œí‘œ (${x}, ${y})ì— ë“œë¡­`);
  
  // ê²½ë¡œ/ë§µ ì¹´ë“œ ì²˜ë¦¬
  if (cardData.cardType === 'path') {
    socket.emit('chat', {
      room: getRoomIdFromUrl(),
      message: JSON.stringify({
        type: 'path',
        data: {
          x: x,
          y: y,
          handNum: cardData.handIndex
        }
      })
    });
  } else if (cardData.cardType === 'rockFail') {
    // í˜„ì¬ ì½”ë“œì™€ ë™ì¼í•œ ì²˜ë¦¬...
  }
}

function handleCardDiscard(cardData) {
  console.log(`ì¹´ë“œ ${cardData.cardId}ë¥¼ ë²„ë¦¬ê¸°`);
  socket.emit('chat', {
    room: getRoomIdFromUrl(),
    message: JSON.stringify({
      type: 'discard',
      data: {
        handNum: cardData.handIndex
      }
    })
  });
}







function animateCardPlacement(x, y) {
  // 1. GameBoardInfo ì—…ë°ì´íŠ¸
  const existingCardIndex = GameBoardInfo.findIndex(cell => cell.x === x && cell.y === y);

  console.log("ì¹´ë“œ ë°°ì¹˜ ì• ë‹ˆë©”ì´ì…˜: GameBoardInfo ì—…ë°ì´íŠ¸ ì™„ë£Œ");

  setTimeout(() => {
    const cell = document.querySelector(`.board-cell[data-x="${x}"][data-y="${y}"]`);
    if (!cell) {
      isAnimating = false;
      return;
    }

    // 4. ì…€ ê°•ì¡° íš¨ê³¼ ì ìš©
    cell.style.transition = 'all 0.5s ease';
    cell.style.boxShadow = '0 0 15px 5px rgba(255, 215, 0, 0.8)';
    cell.style.zIndex = '10';

    // 5. ë°˜ì§ì´ëŠ” íš¨ê³¼ ì¶”ê°€
    const flash = document.createElement('div');
    flash.style.position = 'absolute';
    flash.style.top = '0';
    flash.style.left = '0';
    flash.style.width = '100%';
    flash.style.height = '100%';
    // flash.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
    flash.style.borderRadius = '5px';
    flash.style.opacity = '0';
    flash.style.transition = 'opacity 0.3s ease';
    flash.style.pointerEvents = 'none'; // í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡
    cell.appendChild(flash);

    // ê¹œë¹¡ì´ëŠ” íš¨ê³¼ ì‹¤í–‰
    setTimeout(() => { flash.style.opacity = '0.8'; }, 100);
    setTimeout(() => { flash.style.opacity = '0'; }, 350);
    setTimeout(() => { 
      if (flash.parentNode === cell) {
        cell.removeChild(flash);
      }
    }, 850);

    // ì…€ íš¨ê³¼ ì •ë¦¬ ë° ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
    setTimeout(() => {
      cell.style.boxShadow = '';
      cell.style.zIndex = '';
      isAnimating = false;
    }, 1500);
  }, 300); // 0.3ì´ˆ(300ms) ë’¤ì— ì‹¤í–‰
}



















  </script>


</body>
</html>
