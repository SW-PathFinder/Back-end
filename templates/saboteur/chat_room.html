<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사보타지 게임 - {{ room_name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .game-area {
            display: flex;
            height: 70vh;
        }
        .players-panel {
            width: 250px;
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
            padding: 20px;
        }
        .game-board {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .chat-area {
            width: 300px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            word-wrap: break-word;
        }
        .message.chat {
            background-color: #e3f2fd;
        }
        .message.game {
            background-color: #f3e5f5;
        }
        .message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .message.system {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .username {
            font-weight: bold;
            margin-right: 5px;
        }
        .input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            background-color: white;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .player-list {
            margin-bottom: 20px;
        }
        .player-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        .player-item.current {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .game-status {
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .game-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .game-controls button {
            font-size: 14px;
        }
        .connection-status {
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .connected {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .disconnected {
            background-color: #ffcdd2;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 사보타지 게임 - {{ room_name }}</h1>
            <div id="connectionStatus" class="connection-status disconnected">연결 중...</div>
        </div>
        
        <div class="game-area">
            <!-- 플레이어 패널 -->
            <div class="players-panel">
                <h3>플레이어 목록</h3>
                <div id="playerList" class="player-list">
                    <!-- 플레이어 목록이 여기에 표시됩니다 -->
                </div>
                
                <div class="game-status">
                    <h4>게임 상태</h4>
                    <div id="gameStatus">대기 중</div>
                    <div id="currentPlayer"></div>
                    <div id="currentRound"></div>
                </div>
                  <div class="game-controls">
                    <button onclick="sendCommand('/help')">도움말</button>
                    <button onclick="sendCommand('/join')" id="joinBtn">게임 참가</button>
                    <button onclick="sendCommand('/start')" id="startBtn">게임 시작</button>
                    <button onclick="sendCommand('/round')" id="roundBtn">라운드 시작</button>
                    <button onclick="sendCommand('/status')">상태 확인</button>
                    <button onclick="sendCommand('/hand')">내 손패</button>
                    <button onclick="sendCommand('/board')">보드 확인</button>
                </div>
            </div>
              <!-- 게임 보드 -->
            <div class="game-board">
                <h3>게임 보드</h3>
                <div id="gameBoard">
                    <p>게임이 시작되면 게임 보드가 표시됩니다.</p>
                    <div style="margin-top: 15px;">
                        <button onclick="quickCommand()" style="background-color: #FF9800;">⚡ 빠른 명령어</button>
                        <button onclick="showCoordinateHelper()" style="background-color: #9C27B0;">📍 좌표 도우미</button>
                    </div>
                </div>
                
                <div id="coordinateHelper" style="display: none; margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                    <h4>좌표 도우미</h4>
                    <p><strong>기본 위치:</strong></p>
                    <ul>
                        <li>홈: (10, 5)</li>
                        <li>목적지: (8, 13), (10, 13), (12, 13)</li>
                        <li>시작 위치 주변: (9,5), (10,6), (11,5) 등</li>
                    </ul>
                    <div style="margin-top: 10px;">
                        <input type="number" id="coordX" placeholder="X" style="width: 60px; margin-right: 5px;">
                        <input type="number" id="coordY" placeholder="Y" style="width: 60px; margin-right: 10px;">
                        <button onclick="playAtCoord()">카드 놓기</button>
                        <button onclick="viewAtCoord()">확인</button>
                        <button onclick="rockfailAtCoord()">파괴</button>
                    </div>
                </div>
                
                <div id="playerHand">
                    <!-- 플레이어의 손패가 여기에 표시됩니다 -->
                </div>
            </div>
            
            <!-- 채팅 영역 -->
            <div class="chat-area">
                <div id="messages" class="messages">
                    <!-- 메시지가 여기에 표시됩니다 -->
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" id="usernameInput" placeholder="닉네임" maxlength="20">
                        <button id="setUsernameBtn" onclick="setUsername()">설정</button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." disabled>
                        <button id="sendBtn" onclick="sendMessage()" disabled>전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomName = '{{ room_name }}';
        let chatSocket = null;
        let username = '';
        let isGameJoined = false;
          // WebSocket 연결
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // username이 설정되어 있으면 쿼리스트링으로 전달
            const userParam = username ? `?user=${encodeURIComponent(username)}` : '';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomName}/${userParam}`;
            
            chatSocket = new WebSocket(wsUrl);
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket 연결됨');
                updateConnectionStatus(true);
            };
            
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleMessage(data);
            };
            
            chatSocket.onclose = function(e) {
                console.log('WebSocket 연결 종료');
                updateConnectionStatus(false);
                // 재연결 시도
                setTimeout(connectWebSocket, 3000);
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket 오류:', e);
                updateConnectionStatus(false);
            };
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = '연결됨';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '연결 끊김';
                statusElement.className = 'connection-status disconnected';
            }
        }
          function handleMessage(data) {
            console.log('메시지 수신:', data);
            
            switch(data.type) {
                case 'chat':
                    addChatMessage(data.username, data.message);
                    break;
                case 'game_update':
                    handleGameUpdate(data.data);
                    break;
                case 'private_game_update':
                    handlePrivateGameUpdate(data.data);
                    break;
                case 'private_message':
                    addPrivateMessage(data.message);
                    break;
                case 'error':
                    addSystemMessage(data.message, 'error');
                    break;
            }
        }
        
        function handleGameUpdate(data) {
            console.log('게임 업데이트:', data);
            
            switch(data.type) {                case 'player_joined':
                    if (data.data.players) {
                        updatePlayerList(data.data.players);
                    }
                    addSystemMessage(`${data.data.player}님이 게임에 참가했습니다.`);
                    break;
                case 'player_left':
                    addSystemMessage(`${data.data.player}님이 게임에서 나갔습니다.`);
                    break;
                case 'game_started':
                    updatePlayerList(data.data.players);
                    updateCurrentPlayer(data.data.current_player);
                    addSystemMessage('게임이 시작되었습니다!');
                    break;
                case 'turn_change':
                    updateCurrentPlayer(data.data);
                    break;
                case 'round_end':
                    addSystemMessage(`라운드 종료! 승자: ${data.data.winner}`);
                    break;
                case 'game_end':
                    addSystemMessage('게임이 종료되었습니다!');
                    console.log('최종 순위:', data.data.rank);
                    break;
                default:
                    addSystemMessage(`게임 이벤트: ${data.type}`);
            }
        }
        
        function handlePrivateGameUpdate(data) {
            console.log('개인 게임 업데이트:', data);
            
            switch(data.type) {
                case 'roundStart':
                    addSystemMessage(`라운드 ${data.data.currnetRound} 시작! 역할: ${data.data.role}`);
                    updatePlayerHand(data.data.hand);
                    break;
                case 'drawCard':
                    addSystemMessage(`카드를 뽑았습니다: ${data.data.card}`);
                    break;
                case 'getGold':
                    addSystemMessage(`금을 획득했습니다: ${data.data.gold}개`);
                    break;
                default:
                    addSystemMessage(`개인 이벤트: ${data.type}`);
            }
        }
          function addChatMessage(username, message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message chat';
            
            // HTML을 지원하도록 innerHTML 사용 (마크다운 스타일 처리)
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **굵게**
                .replace(/\n/g, '<br>');  // 줄바꿈
                
            messageElement.innerHTML = `<span class="username">${username}:</span>${formattedMessage}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addPrivateMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.style.backgroundColor = '#fff3e0';
            messageElement.style.borderLeft = '3px solid #ff9800';
            
            // HTML을 지원하도록 innerHTML 사용
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
                
            messageElement.innerHTML = `🔒 ${formattedMessage}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addSystemMessage(message, type = 'system') {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
          function updatePlayerList(players) {
            if (!players || !Array.isArray(players)) {
                console.warn('플레이어 목록이 유효하지 않습니다:', players);
                return;
            }
            
            const playerListDiv = document.getElementById('playerList');
            playerListDiv.innerHTML = '';
            
            players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.textContent = player;
                playerListDiv.appendChild(playerElement);
            });
        }
        
        function updateCurrentPlayer(currentPlayer) {
            document.getElementById('currentPlayer').textContent = `현재 턴: ${currentPlayer}`;
            
            // 플레이어 목록에서 현재 플레이어 하이라이트
            const playerItems = document.querySelectorAll('.player-item');
            playerItems.forEach(item => {
                item.classList.remove('current');
                if (item.textContent === currentPlayer) {
                    item.classList.add('current');
                }
            });
        }
        
        function updatePlayerHand(hand) {
            const handDiv = document.getElementById('playerHand');
            handDiv.innerHTML = '<h4>내 손패:</h4>';
            
            hand.forEach((card, index) => {
                const cardElement = document.createElement('button');
                cardElement.textContent = `카드 ${card[0]}`;
                cardElement.onclick = () => playCard(index);
                handDiv.appendChild(cardElement);
            });
        }
          function setUsername() {
            const usernameInput = document.getElementById('usernameInput');
            const newUsername = usernameInput.value.trim();
            
            if (!newUsername) {
                alert('닉네임을 입력해주세요.');
                return;
            }
            
            username = newUsername;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('usernameInput').disabled = true;
            document.getElementById('setUsernameBtn').disabled = true;
            
            addSystemMessage(`닉네임이 "${username}"로 설정되었습니다.`);
            
            // 기존 WebSocket 연결 종료 후 새 이름으로 재연결
            if (chatSocket) {
                chatSocket.close();
            }
            setTimeout(() => {
                connectWebSocket();
            }, 100);
        }
          function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !username) return;
            
            chatSocket.send(JSON.stringify({
                'type': 'chat',
                'message': message,
                'username': username
            }));
            
            messageInput.value = '';
        }
        
        function sendCommand(command) {
            if (!username) {
                alert('먼저 닉네임을 설정해주세요.');
                return;
            }
            
            chatSocket.send(JSON.stringify({
                'type': 'chat',
                'message': command,
                'username': username
            }));
        }
        
        function quickCommand() {
            const commands = [
                '/help - 도움말',
                '/join - 게임 참가',
                '/start - 게임 시작',
                '/round - 라운드 시작',
                '/status - 상태 확인',
                '/hand - 내 손패',
                '/board - 보드 확인',
                '/play 0 10 6 - 카드 놓기',
                '/discard 0 - 카드 버리기',
                '/sabotage 상대이름 pickaxe - 사보타주',
                '/repair 상대이름 pickaxe - 수리',
                '/view 12 13 - 목적지 확인',
                '/rockfail 10 7 - 경로 파괴'
            ];
            
            const command = prompt('명령어를 선택하거나 직접 입력하세요:\n\n' + commands.join('\n'));
            if (command) {
                sendCommand(command);
            }
        }
        
        function joinGame() {
            if (!username) {
                alert('먼저 닉네임을 설정해주세요.');
                return;
            }
            
            chatSocket.send(JSON.stringify({
                'type': 'join_game',
                'player_name': username
            }));
            
            isGameJoined = true;
            document.getElementById('joinGameBtn').disabled = true;
            document.getElementById('startGameBtn').disabled = false;
        }
        
        function startGame() {
            chatSocket.send(JSON.stringify({
                'type': 'start_game'
            }));
            
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('roundStartBtn').disabled = false;
        }
        
        function roundStart() {
            chatSocket.send(JSON.stringify({
                'type': 'game_action',
                'player_name': username,
                'action': 'roundStart'
            }));
        }
          function playCard(handNum) {
            const x = prompt('X 좌표를 입력하세요:');
            const y = prompt('Y 좌표를 입력하세요:');
            
            if (x && y) {
                sendCommand(`/play ${handNum} ${x} ${y}`);
            }
        }
        
        function showCoordinateHelper() {
            const helper = document.getElementById('coordinateHelper');
            helper.style.display = helper.style.display === 'none' ? 'block' : 'none';
        }
        
        function playAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            const handNum = prompt('사용할 카드 번호를 입력하세요 (0-5):');
            
            if (x && y && handNum !== null) {
                sendCommand(`/play ${handNum} ${x} ${y}`);
            }
        }
        
        function viewAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            
            if (x && y) {
                sendCommand(`/view ${x} ${y}`);
            }
        }
        
        function rockfailAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            
            if (x && y) {
                sendCommand(`/rockfail ${x} ${y}`);
            }
        }
        
        // Enter 키로 메시지 전송
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        document.getElementById('usernameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setUsername();
            }
        });
        
        // 페이지 로드 시 WebSocket 연결
        connectWebSocket();
    </script>
</body>
</html>
