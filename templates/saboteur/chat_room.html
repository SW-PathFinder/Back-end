<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë³´íƒ€ì§€ ê²Œì„ - {{ room_name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .game-area {
            display: flex;
            height: 70vh;
        }
        .players-panel {
            width: 250px;
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
            padding: 20px;
        }
        .game-board {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .chat-area {
            width: 300px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            word-wrap: break-word;
        }
        .message.chat {
            background-color: #e3f2fd;
        }
        .message.game {
            background-color: #f3e5f5;
        }
        .message.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .message.system {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .username {
            font-weight: bold;
            margin-right: 5px;
        }
        .input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            background-color: white;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .player-list {
            margin-bottom: 20px;
        }
        .player-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        .player-item.current {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .game-status {
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .game-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .game-controls button {
            font-size: 14px;
        }
        .connection-status {
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .connected {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .disconnected {
            background-color: #ffcdd2;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® ì‚¬ë³´íƒ€ì§€ ê²Œì„ - {{ room_name }}</h1>
            <div id="connectionStatus" class="connection-status disconnected">ì—°ê²° ì¤‘...</div>
        </div>
        
        <div class="game-area">
            <!-- í”Œë ˆì´ì–´ íŒ¨ë„ -->
            <div class="players-panel">
                <h3>í”Œë ˆì´ì–´ ëª©ë¡</h3>
                <div id="playerList" class="player-list">
                    <!-- í”Œë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="game-status">
                    <h4>ê²Œì„ ìƒíƒœ</h4>
                    <div id="gameStatus">ëŒ€ê¸° ì¤‘</div>
                    <div id="currentPlayer"></div>
                    <div id="currentRound"></div>
                </div>
                  <div class="game-controls">
                    <button onclick="sendCommand('/help')">ë„ì›€ë§</button>
                    <button onclick="sendCommand('/join')" id="joinBtn">ê²Œì„ ì°¸ê°€</button>
                    <button onclick="sendCommand('/start')" id="startBtn">ê²Œì„ ì‹œì‘</button>
                    <button onclick="sendCommand('/round')" id="roundBtn">ë¼ìš´ë“œ ì‹œì‘</button>
                    <button onclick="sendCommand('/status')">ìƒíƒœ í™•ì¸</button>
                    <button onclick="sendCommand('/hand')">ë‚´ ì†íŒ¨</button>
                    <button onclick="sendCommand('/board')">ë³´ë“œ í™•ì¸</button>
                </div>
            </div>
              <!-- ê²Œì„ ë³´ë“œ -->
            <div class="game-board">
                <h3>ê²Œì„ ë³´ë“œ</h3>
                <div id="gameBoard">
                    <p>ê²Œì„ì´ ì‹œì‘ë˜ë©´ ê²Œì„ ë³´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <div style="margin-top: 15px;">
                        <button onclick="quickCommand()" style="background-color: #FF9800;">âš¡ ë¹ ë¥¸ ëª…ë ¹ì–´</button>
                        <button onclick="showCoordinateHelper()" style="background-color: #9C27B0;">ğŸ“ ì¢Œí‘œ ë„ìš°ë¯¸</button>
                    </div>
                </div>
                
                <div id="coordinateHelper" style="display: none; margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                    <h4>ì¢Œí‘œ ë„ìš°ë¯¸</h4>
                    <p><strong>ê¸°ë³¸ ìœ„ì¹˜:</strong></p>
                    <ul>
                        <li>í™ˆ: (10, 5)</li>
                        <li>ëª©ì ì§€: (8, 13), (10, 13), (12, 13)</li>
                        <li>ì‹œì‘ ìœ„ì¹˜ ì£¼ë³€: (9,5), (10,6), (11,5) ë“±</li>
                    </ul>
                    <div style="margin-top: 10px;">
                        <input type="number" id="coordX" placeholder="X" style="width: 60px; margin-right: 5px;">
                        <input type="number" id="coordY" placeholder="Y" style="width: 60px; margin-right: 10px;">
                        <button onclick="playAtCoord()">ì¹´ë“œ ë†“ê¸°</button>
                        <button onclick="viewAtCoord()">í™•ì¸</button>
                        <button onclick="rockfailAtCoord()">íŒŒê´´</button>
                    </div>
                </div>
                
                <div id="playerHand">
                    <!-- í”Œë ˆì´ì–´ì˜ ì†íŒ¨ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ì±„íŒ… ì˜ì—­ -->
            <div class="chat-area">
                <div id="messages" class="messages">
                    <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" id="usernameInput" placeholder="ë‹‰ë„¤ì„" maxlength="20">
                        <button id="setUsernameBtn" onclick="setUsername()">ì„¤ì •</button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                        <button id="sendBtn" onclick="sendMessage()" disabled>ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomName = '{{ room_name }}';
        let chatSocket = null;
        let username = '';
        let isGameJoined = false;
          // WebSocket ì—°ê²°
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // usernameì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì „ë‹¬
            const userParam = username ? `?user=${encodeURIComponent(username)}` : '';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomName}/${userParam}`;
            
            chatSocket = new WebSocket(wsUrl);
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket ì—°ê²°ë¨');
                updateConnectionStatus(true);
            };
            
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleMessage(data);
            };
            
            chatSocket.onclose = function(e) {
                console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                updateConnectionStatus(false);
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 3000);
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket ì˜¤ë¥˜:', e);
                updateConnectionStatus(false);
            };
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = 'ì—°ê²°ë¨';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'ì—°ê²° ëŠê¹€';
                statusElement.className = 'connection-status disconnected';
            }
        }
          function handleMessage(data) {
            console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
            
            switch(data.type) {
                case 'chat':
                    addChatMessage(data.username, data.message);
                    break;
                case 'game_update':
                    handleGameUpdate(data.data);
                    break;
                case 'private_game_update':
                    handlePrivateGameUpdate(data.data);
                    break;
                case 'private_message':
                    addPrivateMessage(data.message);
                    break;
                case 'error':
                    addSystemMessage(data.message, 'error');
                    break;
            }
        }
        
        function handleGameUpdate(data) {
            console.log('ê²Œì„ ì—…ë°ì´íŠ¸:', data);
            
            switch(data.type) {                case 'player_joined':
                    if (data.data.players) {
                        updatePlayerList(data.data.players);
                    }
                    addSystemMessage(`${data.data.player}ë‹˜ì´ ê²Œì„ì— ì°¸ê°€í–ˆìŠµë‹ˆë‹¤.`);
                    break;
                case 'player_left':
                    addSystemMessage(`${data.data.player}ë‹˜ì´ ê²Œì„ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
                    break;
                case 'game_started':
                    updatePlayerList(data.data.players);
                    updateCurrentPlayer(data.data.current_player);
                    addSystemMessage('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    break;
                case 'turn_change':
                    updateCurrentPlayer(data.data);
                    break;
                case 'round_end':
                    addSystemMessage(`ë¼ìš´ë“œ ì¢…ë£Œ! ìŠ¹ì: ${data.data.winner}`);
                    break;
                case 'game_end':
                    addSystemMessage('ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    console.log('ìµœì¢… ìˆœìœ„:', data.data.rank);
                    break;
                default:
                    addSystemMessage(`ê²Œì„ ì´ë²¤íŠ¸: ${data.type}`);
            }
        }
        
        function handlePrivateGameUpdate(data) {
            console.log('ê°œì¸ ê²Œì„ ì—…ë°ì´íŠ¸:', data);
            
            switch(data.type) {
                case 'roundStart':
                    addSystemMessage(`ë¼ìš´ë“œ ${data.data.currnetRound} ì‹œì‘! ì—­í• : ${data.data.role}`);
                    updatePlayerHand(data.data.hand);
                    break;
                case 'drawCard':
                    addSystemMessage(`ì¹´ë“œë¥¼ ë½‘ì•˜ìŠµë‹ˆë‹¤: ${data.data.card}`);
                    break;
                case 'getGold':
                    addSystemMessage(`ê¸ˆì„ íšë“í–ˆìŠµë‹ˆë‹¤: ${data.data.gold}ê°œ`);
                    break;
                default:
                    addSystemMessage(`ê°œì¸ ì´ë²¤íŠ¸: ${data.type}`);
            }
        }
          function addChatMessage(username, message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message chat';
            
            // HTMLì„ ì§€ì›í•˜ë„ë¡ innerHTML ì‚¬ìš© (ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì²˜ë¦¬)
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **êµµê²Œ**
                .replace(/\n/g, '<br>');  // ì¤„ë°”ê¿ˆ
                
            messageElement.innerHTML = `<span class="username">${username}:</span>${formattedMessage}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addPrivateMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.style.backgroundColor = '#fff3e0';
            messageElement.style.borderLeft = '3px solid #ff9800';
            
            // HTMLì„ ì§€ì›í•˜ë„ë¡ innerHTML ì‚¬ìš©
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
                
            messageElement.innerHTML = `ğŸ”’ ${formattedMessage}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addSystemMessage(message, type = 'system') {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
          function updatePlayerList(players) {
            if (!players || !Array.isArray(players)) {
                console.warn('í”Œë ˆì´ì–´ ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', players);
                return;
            }
            
            const playerListDiv = document.getElementById('playerList');
            playerListDiv.innerHTML = '';
            
            players.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.textContent = player;
                playerListDiv.appendChild(playerElement);
            });
        }
        
        function updateCurrentPlayer(currentPlayer) {
            document.getElementById('currentPlayer').textContent = `í˜„ì¬ í„´: ${currentPlayer}`;
            
            // í”Œë ˆì´ì–´ ëª©ë¡ì—ì„œ í˜„ì¬ í”Œë ˆì´ì–´ í•˜ì´ë¼ì´íŠ¸
            const playerItems = document.querySelectorAll('.player-item');
            playerItems.forEach(item => {
                item.classList.remove('current');
                if (item.textContent === currentPlayer) {
                    item.classList.add('current');
                }
            });
        }
        
        function updatePlayerHand(hand) {
            const handDiv = document.getElementById('playerHand');
            handDiv.innerHTML = '<h4>ë‚´ ì†íŒ¨:</h4>';
            
            hand.forEach((card, index) => {
                const cardElement = document.createElement('button');
                cardElement.textContent = `ì¹´ë“œ ${card[0]}`;
                cardElement.onclick = () => playCard(index);
                handDiv.appendChild(cardElement);
            });
        }
          function setUsername() {
            const usernameInput = document.getElementById('usernameInput');
            const newUsername = usernameInput.value.trim();
            
            if (!newUsername) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            username = newUsername;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('usernameInput').disabled = true;
            document.getElementById('setUsernameBtn').disabled = true;
            
            addSystemMessage(`ë‹‰ë„¤ì„ì´ "${username}"ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // ê¸°ì¡´ WebSocket ì—°ê²° ì¢…ë£Œ í›„ ìƒˆ ì´ë¦„ìœ¼ë¡œ ì¬ì—°ê²°
            if (chatSocket) {
                chatSocket.close();
            }
            setTimeout(() => {
                connectWebSocket();
            }, 100);
        }
          function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !username) return;
            
            chatSocket.send(JSON.stringify({
                'type': 'chat',
                'message': message,
                'username': username
            }));
            
            messageInput.value = '';
        }
        
        function sendCommand(command) {
            if (!username) {
                alert('ë¨¼ì € ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            chatSocket.send(JSON.stringify({
                'type': 'chat',
                'message': command,
                'username': username
            }));
        }
        
        function quickCommand() {
            const commands = [
                '/help - ë„ì›€ë§',
                '/join - ê²Œì„ ì°¸ê°€',
                '/start - ê²Œì„ ì‹œì‘',
                '/round - ë¼ìš´ë“œ ì‹œì‘',
                '/status - ìƒíƒœ í™•ì¸',
                '/hand - ë‚´ ì†íŒ¨',
                '/board - ë³´ë“œ í™•ì¸',
                '/play 0 10 6 - ì¹´ë“œ ë†“ê¸°',
                '/discard 0 - ì¹´ë“œ ë²„ë¦¬ê¸°',
                '/sabotage ìƒëŒ€ì´ë¦„ pickaxe - ì‚¬ë³´íƒ€ì£¼',
                '/repair ìƒëŒ€ì´ë¦„ pickaxe - ìˆ˜ë¦¬',
                '/view 12 13 - ëª©ì ì§€ í™•ì¸',
                '/rockfail 10 7 - ê²½ë¡œ íŒŒê´´'
            ];
            
            const command = prompt('ëª…ë ¹ì–´ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”:\n\n' + commands.join('\n'));
            if (command) {
                sendCommand(command);
            }
        }
        
        function joinGame() {
            if (!username) {
                alert('ë¨¼ì € ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            chatSocket.send(JSON.stringify({
                'type': 'join_game',
                'player_name': username
            }));
            
            isGameJoined = true;
            document.getElementById('joinGameBtn').disabled = true;
            document.getElementById('startGameBtn').disabled = false;
        }
        
        function startGame() {
            chatSocket.send(JSON.stringify({
                'type': 'start_game'
            }));
            
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('roundStartBtn').disabled = false;
        }
        
        function roundStart() {
            chatSocket.send(JSON.stringify({
                'type': 'game_action',
                'player_name': username,
                'action': 'roundStart'
            }));
        }
          function playCard(handNum) {
            const x = prompt('X ì¢Œí‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            const y = prompt('Y ì¢Œí‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (x && y) {
                sendCommand(`/play ${handNum} ${x} ${y}`);
            }
        }
        
        function showCoordinateHelper() {
            const helper = document.getElementById('coordinateHelper');
            helper.style.display = helper.style.display === 'none' ? 'block' : 'none';
        }
        
        function playAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            const handNum = prompt('ì‚¬ìš©í•  ì¹´ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (0-5):');
            
            if (x && y && handNum !== null) {
                sendCommand(`/play ${handNum} ${x} ${y}`);
            }
        }
        
        function viewAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            
            if (x && y) {
                sendCommand(`/view ${x} ${y}`);
            }
        }
        
        function rockfailAtCoord() {
            const x = document.getElementById('coordX').value;
            const y = document.getElementById('coordY').value;
            
            if (x && y) {
                sendCommand(`/rockfail ${x} ${y}`);
            }
        }
        
        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        document.getElementById('usernameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setUsername();
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
        connectWebSocket();
    </script>
</body>
</html>
